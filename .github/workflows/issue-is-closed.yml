name: Move Issue to Done When Closed

on:
  issues:
    types:
      - closed

jobs:
  move-to-done:
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to Done
        env:
          GITHUB_TOKEN: ${{ secrets.SECRET_PAT }}
          ORGANIZATION: thomasthorntoncloud
          PROJECT_NUMBER: 1
        run: |
          # View project details
          PROJECT_ID=$(gh project view $PROJECT_NUMBER --owner $ORGANIZATION --json id --jq '.id')
          echo "PROJECT_ID: $PROJECT_ID"

          # List project fields to find Status field
          FIELDS=$(gh project field-list $PROJECT_ID --json id,name,options --jq '.[] | select(.name == "Status")')
          STATUS_FIELD_ID=$(echo "$FIELDS" | jq -r '.id')
          DONE_OPTION_ID=$(echo "$FIELDS" | jq -r '.options[] | select(.name == "Done") | .id')
          echo "STATUS_FIELD_ID: $STATUS_FIELD_ID"
          echo "DONE_OPTION_ID: $DONE_OPTION_ID"

          # List project items with pagination to find the closed issue
          ITEM_ID=""
          CURSOR=""
          while [ -z "$ITEM_ID" ]; do
            ITEMS=$(gh project item-list $PROJECT_ID --json id,content --jq '.[] | select(.content.number == ${{ github.event.issue.number }}) | .id')
            ITEM_ID=$(echo "$ITEMS" | jq -r '.id')
            
            if [ -n "$ITEM_ID" ]; then
              break
            fi
            
            CURSOR=$(gh project item-list $PROJECT_ID --json pageInfo --jq '.pageInfo.endCursor')
            if [ "$CURSOR" = "null" ]; then
              break
            fi
          done

          echo "ITEM_ID: $ITEM_ID"

          if [ -z "$ITEM_ID" ]; then
            echo "Error: Could not find the issue in the project. Skipping status update."
            exit 0
          fi

          # Update the item's Status to Done
          gh project item-update $PROJECT_ID $ITEM_ID --field $STATUS_FIELD_ID --value $DONE_OPTION_ID

          echo "Issue successfully moved to Done status."

      - name: Confirm status update
        if: success()
        run: echo "Issue moved to Done status successfully."